"use strict";!function(){function t(){}function e(t,e,i,n,o,r){r.set({url:o.url,returnHttpPromise:!0});var l="ontouchstart"in window||navigator.MaxTouchPoints>0||navigator.msMaxTouchPoints>0;l?n.options({trigger:"dontTrigger"}):n.options({trigger:"mouseenter outsideClick"}),e.otherwise("/"),t.state("main",{url:"/",views:{nav:{templateUrl:"views/nav.tpl.html",controller:"NavController"},main:{templateUrl:"views/main.tpl.html",controller:"MainController",controllerAs:"ctrl"}}}).state("editor",{url:"/editor",views:{nav:{templateUrl:"views/nav.tpl.html",controller:"NavController"},main:{templateUrl:"views/editor.tpl.html",controller:"EditorController",controllerAs:"ctrl"}}})}angular.module("app",["app-templates","ui.router","ui.bootstrap","angular-jsonrpc-client"]).config(["$stateProvider","$urlRouterProvider","$sceDelegateProvider","$uibTooltipProvider","Config","jsonrpcConfigProvider",e]).run([t])}(),function(){function t(t,e,i){var n,o={},r={key:e.key};return o.getAll=function(){var e=i.defer();return n?e.resolve(n):t.request("get_cities",angular.merge({},r)).then(function(t){t.data.result?(n=t.data.result,e.resolve(n)):e.reject()},function(){e.reject()}),e.promise},o.createCity=function(e,o,l){var a=i.defer(),c={name:e,lat:o,lon:l};return t.request("create_city",angular.merge({},r,c)).then(function(t){t.data.result?(n.push({city_name:e,lat:o,lon:l,city_id:t.data.result,districts:[]}),a.resolve(t)):a.reject()},function(){a.reject()}),a.promise},o.deleteCity=function(e){var o=i.defer();return t.request("delete_city",angular.merge({},r,{city_id:e})).then(function(t){if(t.data.result==e){for(var i in n)if(n[i].city_id==e){n.splice(i,1);break}o.resolve()}else o.reject()},function(){o.reject()}),o.promise},o.setCity=function(e,o,l,a){var c=i.defer(),s={city_id:e,name:o,lat:l,lon:a};return t.request("set_city",angular.merge({},r,s)).then(function(t){if(t.data.result){for(var i in n)if(n[i].city_id==e){n[i].city_name=s.name,n[i].lat=s.lat,n[i].lon=s.lon;break}c.resolve(t)}else c.reject()},function(){c.reject()}),c.promise},o.createDistrict=function(e,o,l){var a=i.defer(),c={name:e,population:o,city_id:l};return t.request("create_district",angular.merge({},r,c)).then(function(t){if(t.data.result){for(var i in n)n[i].city_id==l&&n[i].districts.push({district_id:t.data.result,name:e,population:o});a.resolve(t)}else a.reject()},function(){a.reject()}),a.promise},o.deleteDistrict=function(e,o){var l=i.defer();return t.request("delete_district",angular.merge({},r,{district_id:e})).then(function(t){if(t.data.result==e){for(var i in n)if(n[i].city_id==o){for(var r in n[i].districts)n[i].districts[r].district_id==e&&n[i].districts.splice(r,1);break}l.resolve()}else l.reject()},function(){l.reject()}),l.promise},o.setDistrict=function(e,o,l,a){var c=i.defer(),s={district_id:e,name:o,population:l};return t.request("set_district",angular.merge({},r,s)).then(function(t){if(t.data.result){for(var i in n)if(n[i].city_id==a){for(var r in n[i].districts)n[i].districts[r].district_id==e&&(n[i].districts[r].name=o,n[i].districts[r].population=l);break}c.resolve(t)}else c.reject()},function(){c.reject()}),c.promise},o}angular.module("app").factory("Cities",["jsonrpc","Config","$q",t])}(),function(){angular.module("app").constant("Config",{url:"http://95.213.207.35:18000/api/",key:"596c8ff6-fb32-42a4-8781-9cb0af956dac"})}(),function(){function t(t){return{restrict:"E",template:"",scope:{points:"<",selected:"&"},link:function(e,i,n){function o(){if(e.points){console.log(e.points);for(var t in e.points)!function(t){L.marker([e.points[t].lat,e.points[t].lon]).on("click",function(){e.$apply(function(){e.selected({index:t})})}).addTo(l)}(t)}}var r=angular.element('<div style="height: 100%; width: 100%; display: block;"></div>');i.append(r);var l=t.L.map(r[0],{center:[55,37],zoom:6});e.$watch("points",o),l._onResize(),t.L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'Map data &copy; <a href="http://osm.org">OpenStreetMap</a> contributors',maxZoom:18,detectRetina:!1,updateWhenZooming:!1,updateWhenIdle:!0,reuseTiles:!1}).addTo(l)}}}angular.module("app").directive("map",["$window",t])}(),function(){function t(t){return{restrict:"E",template:"",scope:{lat:"<",lon:"<",clicked:"&"},link:function(e,i,n){function o(){void 0!=e.lat&&void 0!=e.lon&&(a.panTo(new L.LatLng(e.lat,e.lon)),l&&a.removeLayer(l),l=L.marker([e.lat,e.lon]).addTo(a))}var r=angular.element('<div style="height: 100%; width: 100%; display: block;"></div>');i.append(r);var l,a=t.L.map(r[0],{center:[e.lat||55,e.lon||37],zoom:6});e.$watch("lat",o),e.$watch("lon",o),a._onResize();var c=!1;a.on("dragstart",function(){c=!0}),a.on("dragend",function(){c=!1}),a.on("click",function(t){c||e.$apply(function(){e.clicked({lat:t.latlng.lat,lon:t.latlng.lng%180})})}),t.L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'Map data &copy; <a href="http://osm.org">OpenStreetMap</a> contributors',maxZoom:18,detectRetina:!1,updateWhenZooming:!1,updateWhenIdle:!0,reuseTiles:!1}).addTo(a)}}}angular.module("app").directive("mapPointPicker",["$window",t])}(),function(){function t(t,e,i,n){e("_ModalController",{$scope:t,$uibModalInstance:i}),t.name=n,t.ok=function(){i.close(!0)}}angular.module("app").controller("ConfirmDeleteController",["$scope","$controller","$uibModalInstance","name",t])}(),function(){function t(t,e,i,n){e("_SaveCityController",{$scope:t,$uibModalInstance:i}),t.saveCity=function(){t.valid&&!t.inProgress&&(t.saved=!1,t.inProgress=!0,n.createCity(t.city.name,1*t.city.lat.toString().replace(",","."),1*t.city.lon.toString().replace(",",".")).then(function(){t.inProgress=!1,t.saved=!0}))},t.oneMore=function(){t.saved=!1,t.city={}}}angular.module("app").controller("CreateCityController",["$scope","$controller","$uibModalInstance","Cities",t])}(),function(){function t(t,e,i,n,o){e("_SaveDistrictController",{$scope:t,$uibModalInstance:i}),t.cityName=o.city_name,t.saveDistrict=function(){t.valid&&!t.inProgress&&(t.saved=!1,t.inProgress=!0,n.createDistrict(t.district.name,1*t.district.population,o.city_id).then(function(){t.inProgress=!1,t.saved=!0}))},t.oneMore=function(){t.saved=!1,t.district={}}}angular.module("app").controller("CreateDistrictController",["$scope","$controller","$uibModalInstance","Cities","city",t])}(),function(){function t(t,e,i,n,o){e("_SaveCityController",{$scope:t,$uibModalInstance:i}),t.city=o,t.editMode=!0,t.saveCity=function(){t.valid&&!t.inProgress&&(t.inProgress=!0,n.setCity(t.city.city_id,t.city.name,1*t.city.lat.toString().replace(",","."),1*t.city.lon.toString().replace(",",".")).then(function(){t.inProgress=!1,i.dismiss()}))}}angular.module("app").controller("SetCityController",["$scope","$controller","$uibModalInstance","Cities","city",t])}(),function(){function t(t,e,i,n,o,r){e("_SaveDistrictController",{$scope:t,$uibModalInstance:i}),t.district=o,t.editMode=!0,t.cityName=r.city_name,t.saveDistrict=function(){t.valid&&!t.inProgress&&(t.inProgress=!0,n.setDistrict(t.district.district_id,t.district.name,1*t.district.population,r.city_id).then(function(){t.inProgress=!1,i.dismiss()}))}}angular.module("app").controller("SetDistrictController",["$scope","$controller","$uibModalInstance","Cities","district","city",t])}(),function(){function t(t,e){function i(){e.dismiss()}t.close=i,t.cancel=i}angular.module("app").controller("_ModalController",["$scope","$uibModalInstance",t])}(),function(){function t(t,e,i){e("_ModalController",{$scope:t,$uibModalInstance:i}),t.valid=!1,t.$watch("city",function(e){t.valid=!0,t.valid=!!e&&t.valid,e&&(t.valid=!!e.name&&t.valid,t.valid=!(!e.lat||isNaN(1*e.lat.toString().replace(",",".")))&&t.valid,t.valid=!(!e.lon||isNaN(1*e.lon.toString().replace(",",".")))&&t.valid)},!0),t.setPoint=function(e,i){t.city.lat=e,t.city.lon=i}}angular.module("app").controller("_SaveCityController",["$scope","$controller","$uibModalInstance",t])}(),function(){function t(t,e,i){e("_ModalController",{$scope:t,$uibModalInstance:i}),t.valid=!1,t.$watch("district",function(e){t.valid=!0,t.valid=!!e&&t.valid,e&&(t.valid=!!e.name&&t.valid,t.valid=!isNaN(1*e.population)&&t.valid)},!0)}angular.module("app").controller("_SaveDistrictController",["$scope","$controller","$uibModalInstance",t])}(),function(){function t(t,e,i){var n=this;e.getAll().then(function(e){t.cities=e}),t.selectedCity=null,t.createCity=function(){i.open({animation:!1,templateUrl:"views/modals/cityForm.tpl.html",controller:"CreateCityController",backdrop:"static"})},t.setCity=function(t){i.open({animation:!1,templateUrl:"views/modals/cityForm.tpl.html",controller:"SetCityController",backdrop:"static",resolve:{city:function(){var e=angular.copy(t);return e.name=e.city_name,e}}})},t.deleteCity=function(t,o){i.open({animation:!1,templateUrl:"views/modals/confirmDeleteCity.tpl.html",controller:"ConfirmDeleteController",resolve:{name:function(){return o}},backdrop:"static"}).result.then(function(i){i&&(n.selectedCity&&n.selectedCity.city_id==t&&(n.selectedCity=null),e.deleteCity(t))})},t.createDistrict=function(){i.open({animation:!1,templateUrl:"views/modals/districtForm.tpl.html",controller:"CreateDistrictController",backdrop:"static",resolve:{city:function(){return n.selectedCity}}})},t.deleteDistrict=function(t,o){i.open({animation:!1,templateUrl:"views/modals/confirmDeleteDistrict.tpl.html",controller:"ConfirmDeleteController",resolve:{name:function(){return o}},backdrop:"static"}).result.then(function(i){i&&e.deleteDistrict(t,n.selectedCity.city_id)})},t.setDistrict=function(t,e){i.open({animation:!1,templateUrl:"views/modals/districtForm.tpl.html",controller:"SetDistrictController",backdrop:"static",resolve:{city:function(){return e},district:function(){return t}}})}}angular.module("app").controller("EditorController",["$scope","Cities","$uibModal",t])}(),function(){function t(t,e,i){function n(){return t.getPop}var o=this;e.getAll().then(function(e){t.cities=e}),t.getPop=function(t){return t.districts.reduce(function(t,e){return t+e.population},0)},t.sortModes={name:["city_name"],population:[n("city"),"city_name"]},t.toggleSortColumn=function(e){t.sortReverse=t.sortColumn==e&&!t.sortReverse,t.sortColumn=e},t.sortColumn="name",t.sortReverse=!1,t.selected=function(e){o.selectedCity=t.cities[e]}}angular.module("app").controller("MainController",["$scope","Cities","$uibModal",t])}(),function(){function t(t,e){t.currState=e.current.name}angular.module("app").controller("NavController",["$scope","$state",t])}();